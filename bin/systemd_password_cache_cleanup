#!/bin/bash
umask 077

pw_cache=/run/initramfs/.password.cache
pw_seed=/run/initramfs/.password.seed

rsa_info=$(grep -o 'rd.rsa=[^[:space:]]\+' /proc/cmdline)
rsa_info=${rsa_info#*=}

update_seed() {
	rsa_src=${rsa_info%/*}
	rsa_dev=${src%-*}
	rsa_offset=${src#*-}
	rsa_key=${rsa_info#*/}

	# Create old/new seed/keys
	pkcs15-crypt -r0 -k "$rsa_key" --sign -i "$pw_seed" -R >"${pw_cache}.old" \
		&& dd if=/dev/urandom of="$pw_seed" bs=256 count=1 status=noxfer 2>/dev/null \
		&& pkcs15-crypt -r0 -k "$rsa_key" --sign -i "$pw_seed" -R >"${pw_cache}.new" \
		|| return 1

	# Devices to process
	devs=( $(awk 'match($1, /luks-(.*)/, a) {system("blkid -U " a[1])}' /etc/crypttab) )

	# Add new key, counting failures
	failures=0
	for $dev in ${devs[@]}; do
		cryptsetup -d "${pw_cache}.old" luksAddKey "$dev" "${pw_cache}.new"
		[[ "$?" -ne 0 ]] && (( failures += 1 ))
	done
	[[ $failures -gt 0 ]] && echo >&2 "*** Failed to add new key to $failures devices ***"
	[[ $failures -eq ${#devs[@]} ]] && return 1

	# Remove old keys
	failures=0
	for $dev in ${devs[@]}; do
		cryptsetup -d "${pw_cache}.new" luksRemoveKey "$dev" "${pw_cache}.old"
		[[ "$?" -ne 0 ]] && (( failures += 1 ))
	done
	[[ $failures -gt 0 ]] && echo >&2 "*** Failed to remove old key from $failures devices ***"
	[[ $failures -eq ${#devs[@]} ]] && return 1

	# Update original seed
	dd if="$pw_seed" of=/dev/"$rsa_dev"\
			bs=256 seek="$rsa_offset" count=1 status=noxfer 2>/dev/null \
		|| return 1
}

if [[ -f "$pw_seed" && -n "$rsa_info" ]]
then update_seed || echo >&2 "Failed to update rsa seed"
fi

rm -f "$pw_seed" "$pw_cache"{,.old,.new}
